#!/usr/bin/env ruby

require 'yaml'
require 'active_support/core_ext/string'


config_path = File.expand_path('../../config.yml', __FILE__)
conf = YAML.load(File.read(config_path))

modules_path = File.expand_path('../../protobuf/modules', __FILE__)


conf.each do |(user, u)|
  modules = u['modules']
  user_path = File.expand_path(user, modules_path)
  system 'mkdir', '-p', user_path

  contents = %{\
// Code generated by bin/module-proto
// source: config.yml
// DO NOT EDIT!


syntax = "proto3";

package babl.#{user};
import "github.com/larskluge/babl/protobuf/messages/main.proto";

}

  modules.each do |mod|
    cc = mod.gsub('-', '_').gsub(/(\d+)/, "\t\\1\t").split("\t").map(&:camelize).join
    contents += %{
service #{cc} {
  rpc IO (babl.BinRequest) returns (babl.BinReply) {}
  rpc Ping (babl.Empty) returns (babl.Pong) {}
}
}
  end

  open(File.expand_path('main.proto', user_path), 'w') { |f| f << contents }
end
